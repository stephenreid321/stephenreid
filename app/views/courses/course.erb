<% 
base_uri = "https://stephenreid.ams3.cdn.digitaloceanspaces.com/courses/#{@course['Name'].gsub(' ', '%20')}"
doc = Nokogiri::HTML(URI.open("#{base_uri}/course.html"))
head = doc.search('head')
body = doc.search('body')

body.search('a[id^=cmnt_ref]').each { |a| a.parent.remove }
body.search('a[id^=cmnt]').each { |a| a.parent.parent.remove }

body.search('img').each { |img|
  img['src'] = "#{base_uri}/#{img['src']}"
  img.remove_attribute('width')
  img.remove_attribute('height')
  img.remove_attribute('style')
  if img.parent.name == 'span'
    img.parent.remove_attribute('style')
  end
}

# Add class to the first image
first_img = body.at('img')
if first_img
  first_img['class'] = 'first-image'
end

# Add movie emoji to YouTube links
body.search('a').each do |link|
  if link['href'] && link['href'].include?('youtube') && link.parent == link.parent.parent.children.first
    link.inner_html = %Q{<img src="/images/youtube.png" class="youtube-icon" />#{link.inner_html}}
  end
  
  # Remove Google redirect from URLs
  if link['href'] && link['href'].match?(/google\.com\/url\?q=(.+?)(&|$)/)
    link['href'] = URI.decode_www_form_component(link['href'].match(/google\.com\/url\?q=(.+?)(&|$)/)[1])
  end
  
  # Shorten very long link text
  if link.content.starts_with?('https://') && link.content.length >= 100
    link.content = link.content.split('/').first(3).join('/') + '/...'
  end
end

# Remove empty paragraph elements before and after unordered lists
body.search('ul').each do |ul|
  # Check previous sibling
  if ul.previous_element && ul.previous_element.name == 'p' && ul.previous_element.text.strip.empty?
    ul.previous_element.remove
  end
  
  # Check next sibling
  if ul.next_element && ul.next_element.name == 'p' && ul.next_element.text.strip.empty?
    ul.next_element.remove
  end
end

%>

<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%= head.inner_html.to_s.gsub('"Overpass"', 'sans-serif') %>
    <title><%= @course['Name'] %></title>
    <style>
      body { margin: 0 !important; font-family: sans-serif;  }
      .container { padding: 20px !important; max-width: 800px; margin: 0 auto;}
      img { max-width: 100%; margin-bottom: 20px }
      .first-image { margin-top: 20px; margin-bottom: 20px; }
      ul { margin-top: 20px !important; margin-bottom: 20px !important; }
      p + ul { margin-top: 0 !important; }
      li { padding-bottom: 0 !important; padding-top: 5px !important; }
      table { margin-left: auto !important }
      a[href^="#"] { display: inline-block; margin-bottom: 5px !important; }
      :target {
        scroll-margin-top: 20px;
      }
      html {
        scroll-padding-top: 20px;
      }
      .source-banner {
        background-color: #f8f9fa;
        padding: 10px 15px;
        font-size: 14px;
        position: sticky;
        top: 0;
        z-index: 1000;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      a .youtube-icon {
        text-decoration: none;
        width: 20px;
        margin-bottom: 0;
        margin-right: 5px;
        display: inline;
      }
      .mobile-hidden {
        display: inline;
      }
      .mobile-visible {
        display: none;
      }
      @media (max-width: 768px) {
        .mobile-hidden {
          display: none;
        }
        .mobile-visible {
          display: inline;
        }
      }
    </style>
  </head>
  <body>
    <% if @course['URL'] %>
      <div class="source-banner">
        A course by <a href="https://stephenreid.net" target="_blank">Stephen Reid</a>
        &middot;
        <span class="mobile-visible">
          <a href="<%= @course['URL'] %>" target="_blank">Original notes</a>
        </span>
        <span class="mobile-hidden">
          Original notes available on
          <a href="<%= @course['URL'] %>" target="_blank">Google Docs</a>
        </span>
        &middot;
        <a href="<%= @course['Dandelion URL'] %>" target="_blank">Event page</a>
      </div>
    <% end %>
    <div class="container">
      <%= body.inner_html %>
    </div>
  </body>
</html>
