<% if !@post['Essay'].blank? %>

  <style>
    mark { color: white }
  </style>
  <script>
    $(function() {
      $('.blog_content p').each(function() {
        // replace “ and ” with "
        $(this).html($(this).html().replace(/“/g, '"').replace(/”/g, '"'));
        // if the whole paragraph is a quote, convert it into a blockquote
        if (!$(this).parent().is('blockquote')) {
          if ($(this).text().trim().match(/^".*"$/)) {
            $(this).replaceWith('<blockquote><p>' + $(this).html() + '</p></blockquote>')
          } else {
            $(this).html($(this).html().replace(/"([^"]*)"/g, function(match, group) {
              // Check if the quote contains at least 5 words
              if (group.split(' ').length >= 2) {
                return '<mark>"' + group + '"</mark>';
              } else {
                return match;
              }
            }));
          }
        }
      })
    })
  </script>

  <div class="row">
    <div class="col-lg-2">
      <div class="d-none d-lg-block" id="toc">
      </div>
    </div>
    <div class="col-lg-8">

      <div class="blog_post">
        <h1 class="post-title">
          <a class="text-contrast" href="/posts/<%=@post.id%>">
            <%= @post['Title'] %>
          </a>
        </h1>

        <p class="fira text-muted mb-1">
          <%= date = Date.parse(@post['Created at']); date.strftime("#{date.day.ordinalize} %b %Y") %>
          <span style="position: relative; top: -0.2em" class="badge badge-primary"><%= @post['Generated by AI'] %></span>
        </p>

        <div class="mb-4">
          <%= @json['html'] %>
        </div>

        <div class="blog_content">
          <%= md @post['Essay'].split("\n")[1..-1].join("\n") %>
        </div>

      </div>
    </div>
  </div>

<% else %>
  <div class="row justify-content-center">
    <% if @json['links']['player'] %>
      <div class="col-lg-9">
        <%= @json['html'] %>
        <%= partial :'knowledgegraph/generate_essay', locals: {post: @post} %>
      </div>
    <% else %>
      <div class="col-lg-4">
        <%= partial :'knowledgegraph/post', locals: { post: @post, json: @json } %>
      </div>
    <% end %>
  </div>
  <% unless @json['links']['player'] %>
    <div class="text-center mt-5">
      <a target="_blank" class="btn btn-lg btn-primary mb-1 mb-lg-0" href="<%= @json['url'] %>">
        <i class="fas fa-book-open"></i> Read the full article
      </a>
    </div>
  <% end %>
<% end %>

<div class="my-5">
  <%= cp(:'knowledgegraph/full_network') %>
</div>
